name: Update Discord Reset Schedule

on:
  schedule:
    # Runs every day at 06:59 UTC (15:59 KST)
    - cron: "59 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Update Discord message
        env:
          WEBHOOK_ID: ${{ secrets.DISCORD_WEBHOOK_ID }}
          WEBHOOK_TOKEN: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
          MESSAGE_ID: ${{ secrets.DISCORD_MESSAGE_ID || '' }}
        run: |
          python << 'EOF'
          import datetime
          import json
          import os
          import urllib.request
          import urllib.error

          WEBHOOK_ID = os.environ.get("WEBHOOK_ID", "").strip()
          WEBHOOK_TOKEN = os.environ.get("WEBHOOK_TOKEN", "").strip()
          MESSAGE_ID = os.environ.get("MESSAGE_ID", "").strip()

          if not WEBHOOK_ID or not WEBHOOK_TOKEN:
              raise RuntimeError("Missing WEBHOOK_ID or WEBHOOK_TOKEN. Check GitHub Secrets.")

          # Time 기준: 16:00 KST
          KST_OFFSET = datetime.timedelta(hours=9)
          now_utc = datetime.datetime.now(datetime.UTC)
          now_kst = now_utc + KST_OFFSET

          # --- Daily reset (16:00 KST) ---
          daily_reset_kst = now_kst.replace(hour=16, minute=0, second=0, microsecond=0)
          if now_kst >= daily_reset_kst:
              daily_reset_kst += datetime.timedelta(days=1)

          # --- Weekly reset (Monday 16:00 KST) ---
          # weekday(): Mon=0 ... Sun=6
          days_until_monday = (7 - daily_reset_kst.weekday()) % 7
          weekly_reset_kst = daily_reset_kst + datetime.timedelta(days=days_until_monday)
          weekly_reset_kst = weekly_reset_kst.replace(hour=16, minute=0, second=0, microsecond=0)

          def to_unix_from_kst(dt_kst):
              # KST datetime -> UTC unix seconds
              dt_utc = dt_kst - KST_OFFSET
              return int(dt_utc.timestamp())

          daily_ts = to_unix_from_kst(daily_reset_kst)
          weekly_ts = to_unix_from_kst(weekly_reset_kst)

          payload = {
              "embeds": [
                  {
                      "title": "Server Reset Schedule",
                      "description": (
                          f"All regions reset at <t:{daily_ts}:t>\n\n"
                          f"• Daily reset <t:{daily_ts}:R>\n"
                          f"• Weekly reset <t:{weekly_ts}:R>"
                      ),
                      "color": 0x2B2D31
                  }
              ]
          }

          def request(method, url, data=None):
              req = urllib.request.Request(
                  url,
                  data=(json.dumps(data).encode("utf-8") if data is not None else None),
                  headers={"Content-Type": "application/json"},
                  method=method
              )
              try:
                  with urllib.request.urlopen(req) as resp:
                      return resp.read().decode("utf-8")
              except urllib.error.HTTPError as e:
                  body = e.read().decode("utf-8")
                  safe_url = url.replace(WEBHOOK_TOKEN, "***TOKEN***")
                  raise RuntimeError(f"{method} {safe_url} -> HTTP {e.code}: {body}") from None

          # 1) MESSAGE_ID가 없으면 새 메시지 생성 (POST) + id 받아오기
          if not MESSAGE_ID:
              create_url = f"https://discord.com/api/webhooks/{WEBHOOK_ID}/{WEBHOOK_TOKEN}?wait=true"
              created = request("POST", create_url, payload)
              created_json = json.loads(created)
              MESSAGE_ID = created_json.get("id", "").strip()

              if not MESSAGE_ID:
                  raise RuntimeError(f"Message created but no ID returned. Response: {created}")

              print("CREATED_MESSAGE_ID:", MESSAGE_ID)
              print("Save this into GitHub Secret: DISCORD_MESSAGE_ID")

          # 2) 해당 메시지 업데이트 (PATCH)
          update_url = f"https://discord.com/api/webhooks/{WEBHOOK_ID}/{WEBHOOK_TOKEN}/messages/{MESSAGE_ID}"
          request("PATCH", update_url, payload)
          print("Discord reset schedule updated.")
          EOF
