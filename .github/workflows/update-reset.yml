name: Update Discord Reset Schedule

on:
  schedule:
    - cron: "59 6 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Update Discord message
        env:
          WEBHOOK_ID: ${{ secrets.DISCORD_WEBHOOK_ID }}
          WEBHOOK_TOKEN: ${{ secrets.DISCORD_WEBHOOK_TOKEN }}
        run: |
          python << 'EOF'
          import datetime
          import json
          import urllib.request
          import os

          WEBHOOK_ID = os.environ["WEBHOOK_ID"]
          WEBHOOK_TOKEN = os.environ["WEBHOOK_TOKEN"]

          KST = datetime.timezone(datetime.timedelta(hours=9))
          UTC = datetime.timezone.utc
          now_utc = datetime.datetime.now(UTC)
          now_kst = now_utc.astimezone(KST)

          daily_reset_kst = now_kst.replace(hour=16, minute=0, second=0, microsecond=0)
          if now_kst >= daily_reset_kst:
              daily_reset_kst += datetime.timedelta(days=1)

          days_until_monday = (0 - daily_reset_kst.weekday()) % 7
          weekly_reset_kst = daily_reset_kst + datetime.timedelta(days=days_until_monday)
          weekly_reset_kst = weekly_reset_kst.replace(hour=16, minute=0, second=0, microsecond=0)
          if weekly_reset_kst <= now_kst:
              weekly_reset_kst += datetime.timedelta(days=7)

          daily_ts = int(daily_reset_kst.timestamp())
          weekly_ts = int(weekly_reset_kst.timestamp())

          payload = {
              "embeds": [
                  {
                      "title": "Server Reset Schedule",
                      "description": (
                          f"All regions reset at <t:{daily_ts}:t>\n\n"
                          f"• Daily reset <t:{daily_ts}:R>\n"
                          f"• Weekly reset <t:{weekly_ts}:R>"
                      ),
                      "color": 0x2B2D31
                  }
              ]
          }

          # Create a brand-new message and print its ID
          create_url = f"https://discord.com/api/webhooks/{WEBHOOK_ID}/{WEBHOOK_TOKEN}"
          req_create = urllib.request.Request(
              create_url,
              data=json.dumps(payload).encode("utf-8"),
              headers={"Content-Type": "application/json"},
              method="POST"
          )

          with urllib.request.urlopen(req_create) as resp:
              body = json.loads(resp.read().decode("utf-8"))
              print("CREATED_MESSAGE_ID:", body["id"])

          EOF
